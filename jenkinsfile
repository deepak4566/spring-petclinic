pipeline {
    agent any

   

    stages {
        stage('Maven Build Artifact') {
            steps {
                sh 'mvn clean package -DskipTests=true -Dcheckstyle.skip=true'
            }
        }

        

stage('trivy_image') {
  steps {
    sh '''
      export TRIVY_CACHE_DIR=/tmp/trivy-cache
      mkdir -p $TRIVY_CACHE_DIR

      trivy image deepak8934/petapp:${BUILD_NUMBER} \
        --scanners vuln \
        --skip-db-update \
        --exit-code 0 \
        --quiet \
        -f table > trivyimage.txt
    '''
  }
}



        stage('SBOM Generation') {
            steps {
                sh '''
                   syft dir:. -o cyclonedx-json > sbom.json
                  '''
            }
        }

        
        stage('Building a Docker Image') {
            steps {
                sh "docker build -t deepak8934/petapp:${BUILD_NUMBER} ."
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh "trivy image deepak8934/petapp:${BUILD_NUMBER} --scanners vuln --exit-code 0 > trivyimage.txt"
            }
        }

        stage('Docker Image Push') {
            steps {
                withDockerRegistry(credentialsId: 'dockercred', url: '') {
                    sh "docker push deepak8934/petapp:${BUILD_NUMBER}"
                }
            }
        }
    }
}
