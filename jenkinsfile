pipeline {
    agent any

   

    stages {
        stage('Maven Build Artifact') {
            steps {
                sh 'mvn clean package -DskipTests=true'
            }
        }

        


        stage('Trivy FS Scan') {
            steps {
                sh 'trivy fs . --scanners config,secret,vuln --exit-code 0 > trivyfs.txt'
            }
        }

        stage('SBOM Generation') {
            steps {
                sh '''
                    curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
                    syft . -o cyclonedx-json > sbom.json
                '''
            }
        }

        stage('SCA Scan (Dependencies)') {
            steps {
                sh 'trivy sbom sbom.json --exit-code 0 > sca_scan.txt'
            }
        }

        stage('Building a Docker Image') {
            steps {
                sh "docker build -t deepak8934/petapp:${BUILD_NUMBER} ."
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh "trivy image deepak8934/petapp:${BUILD_NUMBER} --scanners vuln --exit-code 0 > trivyimage.txt"
            }
        }

        stage('Docker Image Push') {
            steps {
                withDockerRegistry(credentialsId: 'dockercred', url: '') {
                    sh "docker push deepak8934/petapp:${BUILD_NUMBER}"
                }
            }
        }
    }
}
